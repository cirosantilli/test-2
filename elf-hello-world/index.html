<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
        ELF Hello World Tutorial -
      
      Ciro Santilli
    </title>
    
      <meta name="description" content="Introductory analysis of a simple example of the Executable and Linkable File format.">
    
    <link rel="shortcut icon" type="image/x-icon" href="https://www.gravatar.com/avatar/c979bd881b6755f84947a5a8ecc7c6f7.png" />
    <!-- #jquery. Must come *before* all its many dependencies. -->
      <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <!-- #bootstrap -->
      <link href="https://netdna.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet"/>
      <script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <!-- #data table -->
      <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css"/>
      <style>
        table.dataTable tr.odd { background-color: white; }
        table.dataTable tr.even { background-color: white; }
        table.dataTable tr.odd td.sorting_1 { background-color: white; }
        table.dataTable tr.odd td.sorting_2 { background-color: white; }
        table.dataTable tr.odd td.sorting_3 { background-color: white; }
        table.dataTable tr.even td.sorting_1 { background-color: white; }
        table.dataTable tr.even td.sorting_2 { background-color: white; }
        table.dataTable tr.even td.sorting_3 { background-color: white; }
      </style>
    <!-- #font awesome font icons -->
      <link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet"/>
    <!-- Custom styles and scripts. Come at end to use and override libraries. -->
      <!--<script src="/assets/main.js"></script>-->
      <link rel="stylesheet" href="/assets/main.css"/>
      <link rel="stylesheet" href="/assets/header-link.css"/>
      <link rel="stylesheet" href="/assets/syntax.css"/>
  </head>
  <body>
    <header>
      <nav class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header ">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Ciro Santilli</a>
          </div>
          <div class="collapse navbar-collapse" id="navbar">
            <ul class="nav navbar-nav">
              
              <li >
                <a href="/articles" title="">Articles</a>
              </li>
              
              <li >
                <a href="/projects" title="">Projects</a>
              </li>
              
              <li >
                <a href="/skills" title="">Skills</a>
              </li>
              
              <li >
                <a href="/interests" title="">Interests</a>
              </li>
              
              <li >
                <a href="/education" title="">Education</a>
              </li>
              
            </ul>
          </div>
        </div>
      </nav>
    </header>
    <div class="article-and-sidebar">
      <div class="content">
        <aside>
          <div>
            <a href="/">
              <img style="width:100%;" src="/assets/me.jpg" alt="">
            </a>
          </div>
          <div>
            <a class="nav" href="https://stackoverflow.com/users/895245"><i class="fa fa-stack-overflow fa-fw"></i>Stack Overflow</a>
            <a class="nav" href="https://github.com/cirosantilli"><i class="fa fa-github fa-fw"></i>GitHub</a>
            <a class="nav" href="https://www.linkedin.com/in/cirosantilli"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
            <a class="nav" href="https://www.youtube.com/channel/UCBrJjpKMpdrkA1VsAiR2wEg"><i class="fa fa-youtube fa-fw"></i>YouTube</a>
            <a class="nav" href="https://twitter.com/cirosantilli"><i class="fa fa-twitter fa-fw"></i>Twitter</a>
            
            <a class="nav" href="https://www.zhihu.com/people/cirosantilli/activities"><i class="fa fa-question-circle fa-fw"></i>Zhihu 知乎</a>
            <a class="nav" href="https://www.weibo.com/p/1005055601627311"><i class="fa fa-weibo fa-fw"></i>Weibo 微博</a>
            
            <a class="nav" href="/accounts"><i class="fa fa-ellipsis-h fa-fw"></i>Other accounts</a>
          </div>
          <div>
            
            
            
            
            
            <a class="nav" href="https://github.com/cirosantilli/cirosantilli.github.io/issues/new?title=ELF+Hello+World+Tutorial%20-%20">
              <i class="fa fa-exclamation-circle fa-fw"></i>Report Issue
            </a>
          </div>
        </aside>
        <main>
          <h1 class="page-title">ELF Hello World Tutorial</h1>
          
          <div id="sharethis">
            <!-- #ShareThis share -->
              <!-- #INVALID HTML5: https://getsatisfaction.com/sharethis/topics/attribute_displaytext_is_not_valid_xhtml -->
              <div class='st_twitter_hcount desktop' displayText='Tweet'></div>
              <div class='st_facebook_hcount desktop' displayText='Facebook'></div>
              <div class='st_googleplus_hcount desktop' displayText='Google +'></div>
              <div class='st_linkedin_hcount desktop' displayText='LinkedIn'></div>
              <div class='st_twitter_large mobile' displayText='Tweet'></div>
              <div class='st_facebook_large mobile' displayText='Facebook'></div>
              <div class='st_googleplus_large mobile' displayText='Google +'></div>
              <div class='st_linkedin_large mobile' displayText='LinkedIn'></div>
              <!--<span class='st_linkedin_hcount' displayText='LinkedIn'></span>-->
              <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
              <script type="text/javascript">stLight.options({publisher: "b6a81f16-5bb1-46de-83c8-6b4c3e94ec99", doNotHash:false, doNotCopy:true, hashAddressBar:false});</script>
          </div>
          
          <p>Introductory analysis of a simple example of the Executable and Linkable File format.</p>
          <p>Extracted from <a href="https://stackoverflow.com/a/30648229/895245">my Stack Overflow answer</a>.</p>

<ol id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a>    <ol>
      <li><a href="#standards" id="markdown-toc-standards">Standards</a></li>
      <li><a href="#how-to-learn" id="markdown-toc-how-to-learn">How to learn</a></li>
      <li><a href="#specified-file-formats" id="markdown-toc-specified-file-formats">Specified file formats</a></li>
      <li><a href="#implementations" id="markdown-toc-implementations">Implementations</a></li>
    </ol>
  </li>
  <li><a href="#minimal-elf-file" id="markdown-toc-minimal-elf-file">Minimal ELF file</a></li>
  <li><a href="#generate-the-example" id="markdown-toc-generate-the-example">Generate the example</a></li>
  <li><a href="#object-hd" id="markdown-toc-object-hd">Object hd</a></li>
  <li><a href="#executable-hd" id="markdown-toc-executable-hd">Executable hd</a></li>
  <li><a href="#global-file-structure" id="markdown-toc-global-file-structure">Global file structure</a></li>
  <li><a href="#section-vs-segment" id="markdown-toc-section-vs-segment">Section vs segment</a></li>
  <li><a href="#elf-header" id="markdown-toc-elf-header">ELF header</a></li>
  <li><a href="#section-header-table" id="markdown-toc-section-header-table">Section header table</a></li>
  <li><a href="#sections" id="markdown-toc-sections">Sections</a>    <ol>
      <li><a href="#index-0-section" id="markdown-toc-index-0-section">Index 0 section</a>        <ol>
          <li><a href="#sht_null" id="markdown-toc-sht_null">SHT_NULL</a></li>
        </ol>
      </li>
      <li><a href="#data-section" id="markdown-toc-data-section">.data section</a></li>
      <li><a href="#text-section" id="markdown-toc-text-section">.text section</a></li>
      <li><a href="#sht_strtab" id="markdown-toc-sht_strtab">SHT_STRTAB</a></li>
      <li><a href="#shstrtab" id="markdown-toc-shstrtab">.shstrtab</a></li>
      <li><a href="#symtab" id="markdown-toc-symtab">.symtab</a>        <ol>
          <li><a href="#stt_file" id="markdown-toc-stt_file">STT_FILE</a></li>
          <li><a href="#stt_section" id="markdown-toc-stt_section">STT_SECTION</a></li>
          <li><a href="#stt_notype" id="markdown-toc-stt_notype">STT_NOTYPE</a>            <ol>
              <li><a href="#shn_abs" id="markdown-toc-shn_abs">SHN_ABS</a></li>
            </ol>
          </li>
          <li><a href="#sht_symtab-on-the-executable" id="markdown-toc-sht_symtab-on-the-executable">SHT_SYMTAB on the executable</a></li>
        </ol>
      </li>
      <li><a href="#strtab" id="markdown-toc-strtab">.strtab</a></li>
      <li><a href="#relatext" id="markdown-toc-relatext">.rela.text</a>        <ol>
          <li><a href="#reltext" id="markdown-toc-reltext">.rel.text</a></li>
        </ol>
      </li>
      <li><a href="#dynamic-linking-sections" id="markdown-toc-dynamic-linking-sections">Dynamic linking sections</a>        <ol>
          <li><a href="#pt_interp" id="markdown-toc-pt_interp">PT_INTERP</a></li>
          <li><a href="#dynamic-section" id="markdown-toc-dynamic-section">Dynamic section</a>            <ol>
              <li><a href="#dt_flags_1" id="markdown-toc-dt_flags_1">DT_FLAGS_1</a>                <ol>
                  <li><a href="#df_1_pie" id="markdown-toc-df_1_pie">DF_1_PIE</a></li>
                </ol>
              </li>
            </ol>
          </li>
        </ol>
      </li>
    </ol>
  </li>
  <li><a href="#program-header-table" id="markdown-toc-program-header-table">Program header table</a></li>
  <li><a href="#backlinks" id="markdown-toc-backlinks">Backlinks</a></li>
</ol>

<h2 id="introduction">Introduction</h2>

<p>ELF is the dominating file format for Linux. It competes with Mach-O for OS X and PE for Windows.</p>

<p>ELF supersedes <code class="highlighter-rouge">.coff</code>, which supersedes <code class="highlighter-rouge">a.out</code>.</p>

<h3 id="standards">Standards</h3>

<p>ELF is specified by the <a href="https://en.wikipedia.org/wiki/Linux_Standard_Base">LSB</a>:</p>

<ul>
  <li>core generic: <a href="https://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/elf-generic.html">https://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/elf-generic.html</a></li>
  <li>core AMD64: <a href="https://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-AMD64/LSB-Core-AMD64/book1.html">https://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-AMD64/LSB-Core-AMD64/book1.html</a></li>
</ul>

<p>The LSB basically links to other standards with minor extensions, in particular:</p>

<ul>
  <li>
    <p>Generic (both by <a href="https://en.wikipedia.org/wiki/Santa_Cruz_Operation">SCO</a>):</p>

    <ul>
      <li>System V ABI 4.1 (1997) <a href="http://www.sco.com/developers/devspecs/gabi41.pdf">http://www.sco.com/developers/devspecs/gabi41.pdf</a>, no 64 bit, although a magic number is reserved for it. Same for core files. <em>This</em> is the first document you should look at when searching for information.</li>
      <li>System V ABI Update DRAFT 17 (2003) <a href="http://www.sco.com/developers/gabi/2003-12-17/contents.html">http://www.sco.com/developers/gabi/2003-12-17/contents.html</a>, adds 64 bit. Only updates chapters 4 and 5 of the previous document: the others remain valid and are still referenced.</li>
    </ul>
  </li>
  <li>
    <p>Architecture specific (by the processor vendor):</p>

    <ul>
      <li>IA-32: <a href="https://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-IA32/LSB-Core-IA32/elf-ia32.html">https://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-IA32/LSB-Core-IA32/elf-ia32.html</a>, points mostly to <a href="http://www.sco.com/developers/devspecs/abi386-4.pdf">http://www.sco.com/developers/devspecs/abi386-4.pdf</a></li>
      <li>AMD64: <a href="https://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-AMD64/LSB-Core-AMD64/elf-amd64.html">https://refspecs.linuxfoundation.org/LSB_4.1.0/LSB-Core-AMD64/LSB-Core-AMD64/elf-amd64.html</a>, points mostly to <a href="http://www.x86-64.org/documentation/abi.pdf">http://www.x86-64.org/documentation/abi.pdf</a></li>
    </ul>
  </li>
</ul>

<p>A handy summary can be found at:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>man elf
</code></pre></div></div>

<h3 id="how-to-learn">How to learn</h3>

<p>Spin like mad between:</p>

<ul>
  <li>standards</li>
  <li>high level generators. We use the assembler <code class="highlighter-rouge">as</code> and linker <code class="highlighter-rouge">ld</code>.</li>
  <li>hexdumps</li>
  <li>file decompilers. We use <code class="highlighter-rouge">readelf</code>. It makes it faster to read the ELF file by turning it into human readable output. But you must have seen one byte-by-byte example first, and think how <code class="highlighter-rouge">readelf</code> output maps to the standard.</li>
  <li>low-level generators: stand-alone libraries that let you control every field of the ELF files you generated. <a href="https://github.com/BR903/ELFkickers">https://github.com/BR903/ELFkickers</a>, <a href="https://github.com/sqall01/ZwoELF">https://github.com/sqall01/ZwoELF</a> and many more on GitHub.</li>
  <li>consumer: the <code class="highlighter-rouge">exec</code> system call of the Linux kernel can parse ELF files to starts processes: <a href="https://github.com/torvalds/linux/blob/v4.11/fs/binfmt_elf.c">https://github.com/torvalds/linux/blob/v4.11/fs/binfmt_elf.c</a>, <a href="https://stackoverflow.com/questions/8352535/how-does-kernel-get-an-executable-binary-file-running-under-linux/31394861#31394861">https://stackoverflow.com/questions/8352535/how-does-kernel-get-an-executable-binary-file-running-under-linux/31394861#31394861</a></li>
</ul>

<h3 id="specified-file-formats">Specified file formats</h3>

<p>The ELF standard specifies multiple file formats:</p>

<ul>
  <li>
    <p>Object files (<code class="highlighter-rouge">.o</code>).</p>

    <p>Intermediate step to generating executables and other formats:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Source code

    |
    | Compilation
    |
    v

Object file

    |
    | Linking
    |
    v

Executable
</code></pre></div>    </div>

    <p>Object files exist to make compilation faster: with <code class="highlighter-rouge">make</code>, we only have to recompile the modified source files based on timestamps.</p>

    <p>We have to do the linking step every time, but it is much less expensive.</p>
  </li>
  <li>
    <p>Executable files (no standard Linux extension).</p>

    <p>This is what the Linux kernel can actually run.</p>
  </li>
  <li>
    <p>Archive files (<code class="highlighter-rouge">.a</code>).</p>

    <p>Libraries meant to be embedded into executables during the Linking step.</p>
  </li>
  <li>
    <p>Shared object files (<code class="highlighter-rouge">.so</code>).</p>

    <p>Libraries meant to be loaded when the executable starts running.</p>
  </li>
  <li>
    <p>Core dumps.</p>

    <p>Such files may be generated by the Linux kernel when the program does naughty things, e.g. segfault.</p>

    <p>They exist to help debugging the program.</p>
  </li>
</ul>

<p>In this tutorial, we consider only object and executable files.</p>

<h3 id="implementations">Implementations</h3>

<ul>
  <li>
    <p>Compiler toolchains generate and read ELF files.</p>

    <p>Sane compilers should use a separate standalone library to do the dirty work. E.g., Binutils uses BFD (in-tree and canonical source).</p>
  </li>
  <li>
    <p>Operating systems read and run ELF files.</p>

    <p>Kernels cannot link to a library nor use the C stlib, so they are more likely to implement it themselves.</p>

    <p>This is the case of the Linux kernel 4.2 which implements it in th file <code class="highlighter-rouge">fs/binfmt_elf.c</code>.</p>
  </li>
  <li>
    <p>Specialized libraries. Examples:</p>

    <ul>
      <li><a href="https://github.com/eliben/pyelftools">https://github.com/eliben/pyelftools</a>. By a hardcore Googler: <a href="https://plus.google.com/+EliBenderskyGplus/posts">https://plus.google.com/+EliBenderskyGplus/posts</a></li>
      <li><a href="https://sourceforge.net/projects/elftoolchain">https://sourceforge.net/projects/elftoolchain</a></li>
    </ul>
  </li>
</ul>

<h2 id="minimal-elf-file">Minimal ELF file</h2>

<p>It is non-trivial to determine what is the smallest legal ELF file, or the smaller one that will do something trivial in Linux.</p>

<p>Some impressive attempts:</p>

<ul>
  <li><a href="https://codegolf.stackexchange.com/questions/5696/shortest-elf-for-hello-world-n">https://codegolf.stackexchange.com/questions/5696/shortest-elf-for-hello-world-n</a></li>
  <li><a href="https://www.muppetlabs.com/~breadbox/software/tiny/">https://www.muppetlabs.com/~breadbox/software/tiny/</a></li>
  <li><a href="http://timelessname.com/elfbin/">http://timelessname.com/elfbin/</a></li>
</ul>

<p>In this example we will consider a saner <code class="highlighter-rouge">hello world</code> example that will better capture real life cases.</p>

<h2 id="generate-the-example">Generate the example</h2>

<p>Let’s break down a minimal runnable Linux x86-64 example:</p>

<p>hello_world.asm</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>section .data
    hello_world db "Hello world!", 10
    hello_world_len  equ $ - hello_world
section .text
    global _start
    _start:
        mov rax, 1
        mov rdi, 1
        mov rsi, hello_world
        mov rdx, hello_world_len
        syscall
        mov rax, 60
        mov rdi, 0
        syscall
</code></pre></div></div>

<p>Compiled with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nasm -w+all -f elf64 -o 'hello_world.o' 'hello_world.asm'
ld -o 'hello_world.out' 'hello_world.o'
</code></pre></div></div>

<p>TODO: use a minimal linker script with <code class="highlighter-rouge">-T</code> to be more precise and minimal.</p>

<p>Versions:</p>

<ul>
  <li>NASM 2.10.09</li>
  <li>Binutils version 2.24 (contains <code class="highlighter-rouge">ld</code>)</li>
  <li>Ubuntu 14.04</li>
</ul>

<p>We don’t use a C program as that would complicate the analysis, that will be level 2 :-)</p>

<h2 id="object-hd">Object hd</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hd hello_world.o
</code></pre></div></div>

<p>Gives:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|
00000010  01 00 3e 00 01 00 00 00  00 00 00 00 00 00 00 00  |..&gt;.............|
00000020  00 00 00 00 00 00 00 00  40 00 00 00 00 00 00 00  |........@.......|
00000030  00 00 00 00 40 00 00 00  00 00 40 00 07 00 03 00  |....@.....@.....|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000080  01 00 00 00 01 00 00 00  03 00 00 00 00 00 00 00  |................|
00000090  00 00 00 00 00 00 00 00  00 02 00 00 00 00 00 00  |................|
000000a0  0d 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000b0  04 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000c0  07 00 00 00 01 00 00 00  06 00 00 00 00 00 00 00  |................|
000000d0  00 00 00 00 00 00 00 00  10 02 00 00 00 00 00 00  |................|
000000e0  27 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |'...............|
000000f0  10 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000100  0d 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  |................|
00000110  00 00 00 00 00 00 00 00  40 02 00 00 00 00 00 00  |........@.......|
00000120  32 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |2...............|
00000130  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000140  17 00 00 00 02 00 00 00  00 00 00 00 00 00 00 00  |................|
00000150  00 00 00 00 00 00 00 00  80 02 00 00 00 00 00 00  |................|
00000160  a8 00 00 00 00 00 00 00  05 00 00 00 06 00 00 00  |................|
00000170  04 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  |................|
00000180  1f 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  |................|
00000190  00 00 00 00 00 00 00 00  30 03 00 00 00 00 00 00  |........0.......|
000001a0  34 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |4...............|
000001b0  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001c0  27 00 00 00 04 00 00 00  00 00 00 00 00 00 00 00  |'...............|
000001d0  00 00 00 00 00 00 00 00  70 03 00 00 00 00 00 00  |........p.......|
000001e0  18 00 00 00 00 00 00 00  04 00 00 00 02 00 00 00  |................|
000001f0  04 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  |................|
00000200  48 65 6c 6c 6f 20 77 6f  72 6c 64 21 0a 00 00 00  |Hello world!....|
00000210  b8 01 00 00 00 bf 01 00  00 00 48 be 00 00 00 00  |..........H.....|
00000220  00 00 00 00 ba 0d 00 00  00 0f 05 b8 3c 00 00 00  |............&lt;...|
00000230  bf 00 00 00 00 0f 05 00  00 00 00 00 00 00 00 00  |................|
00000240  00 2e 64 61 74 61 00 2e  74 65 78 74 00 2e 73 68  |..data..text..sh|
00000250  73 74 72 74 61 62 00 2e  73 79 6d 74 61 62 00 2e  |strtab..symtab..|
00000260  73 74 72 74 61 62 00 2e  72 65 6c 61 2e 74 65 78  |strtab..rela.tex|
00000270  74 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |t...............|
00000280  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000290  00 00 00 00 00 00 00 00  01 00 00 00 04 00 f1 ff  |................|
000002a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000002b0  00 00 00 00 03 00 01 00  00 00 00 00 00 00 00 00  |................|
000002c0  00 00 00 00 00 00 00 00  00 00 00 00 03 00 02 00  |................|
000002d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000002e0  11 00 00 00 00 00 01 00  00 00 00 00 00 00 00 00  |................|
000002f0  00 00 00 00 00 00 00 00  1d 00 00 00 00 00 f1 ff  |................|
00000300  0d 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000310  2d 00 00 00 10 00 02 00  00 00 00 00 00 00 00 00  |-...............|
00000320  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000330  00 68 65 6c 6c 6f 5f 77  6f 72 6c 64 2e 61 73 6d  |.hello_world.asm|
00000340  00 68 65 6c 6c 6f 5f 77  6f 72 6c 64 00 68 65 6c  |.hello_world.hel|
00000350  6c 6f 5f 77 6f 72 6c 64  5f 6c 65 6e 00 5f 73 74  |lo_world_len._st|
00000360  61 72 74 00 00 00 00 00  00 00 00 00 00 00 00 00  |art.............|
00000370  0c 00 00 00 00 00 00 00  01 00 00 00 02 00 00 00  |................|
00000380  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000390
</code></pre></div></div>

<h2 id="executable-hd">Executable hd</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hd hello_world.out
</code></pre></div></div>

<p>Gives:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|
00000010  02 00 3e 00 01 00 00 00  b0 00 40 00 00 00 00 00  |..&gt;.......@.....|
00000020  40 00 00 00 00 00 00 00  10 01 00 00 00 00 00 00  |@...............|
00000030  00 00 00 00 40 00 38 00  02 00 40 00 06 00 03 00  |....@.8...@.....|
00000040  01 00 00 00 05 00 00 00  00 00 00 00 00 00 00 00  |................|
00000050  00 00 40 00 00 00 00 00  00 00 40 00 00 00 00 00  |..@.......@.....|
00000060  d7 00 00 00 00 00 00 00  d7 00 00 00 00 00 00 00  |................|
00000070  00 00 20 00 00 00 00 00  01 00 00 00 06 00 00 00  |.. .............|
00000080  d8 00 00 00 00 00 00 00  d8 00 60 00 00 00 00 00  |..........`.....|
00000090  d8 00 60 00 00 00 00 00  0d 00 00 00 00 00 00 00  |..`.............|
000000a0  0d 00 00 00 00 00 00 00  00 00 20 00 00 00 00 00  |.......... .....|
000000b0  b8 01 00 00 00 bf 01 00  00 00 48 be d8 00 60 00  |..........H...`.|
000000c0  00 00 00 00 ba 0d 00 00  00 0f 05 b8 3c 00 00 00  |............&lt;...|
000000d0  bf 00 00 00 00 0f 05 00  48 65 6c 6c 6f 20 77 6f  |........Hello wo|
000000e0  72 6c 64 21 0a 00 2e 73  79 6d 74 61 62 00 2e 73  |rld!...symtab..s|
000000f0  74 72 74 61 62 00 2e 73  68 73 74 72 74 61 62 00  |trtab..shstrtab.|
00000100  2e 74 65 78 74 00 2e 64  61 74 61 00 00 00 00 00  |.text..data.....|
00000110  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000150  1b 00 00 00 01 00 00 00  06 00 00 00 00 00 00 00  |................|
00000160  b0 00 40 00 00 00 00 00  b0 00 00 00 00 00 00 00  |..@.............|
00000170  27 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |'...............|
00000180  10 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000190  21 00 00 00 01 00 00 00  03 00 00 00 00 00 00 00  |!...............|
000001a0  d8 00 60 00 00 00 00 00  d8 00 00 00 00 00 00 00  |..`.............|
000001b0  0d 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001c0  04 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001d0  11 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  |................|
000001e0  00 00 00 00 00 00 00 00  e5 00 00 00 00 00 00 00  |................|
000001f0  27 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |'...............|
00000200  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000210  01 00 00 00 02 00 00 00  00 00 00 00 00 00 00 00  |................|
00000220  00 00 00 00 00 00 00 00  90 02 00 00 00 00 00 00  |................|
00000230  08 01 00 00 00 00 00 00  05 00 00 00 07 00 00 00  |................|
00000240  08 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  |................|
00000250  09 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  |................|
00000260  00 00 00 00 00 00 00 00  98 03 00 00 00 00 00 00  |................|
00000270  4c 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |L...............|
00000280  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000290  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000002a0  00 00 00 00 00 00 00 00  00 00 00 00 03 00 01 00  |................|
000002b0  b0 00 40 00 00 00 00 00  00 00 00 00 00 00 00 00  |..@.............|
000002c0  00 00 00 00 03 00 02 00  d8 00 60 00 00 00 00 00  |..........`.....|
000002d0  00 00 00 00 00 00 00 00  01 00 00 00 04 00 f1 ff  |................|
000002e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000002f0  11 00 00 00 00 00 02 00  d8 00 60 00 00 00 00 00  |..........`.....|
00000300  00 00 00 00 00 00 00 00  1d 00 00 00 00 00 f1 ff  |................|
00000310  0d 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000320  00 00 00 00 04 00 f1 ff  00 00 00 00 00 00 00 00  |................|
00000330  00 00 00 00 00 00 00 00  2d 00 00 00 10 00 01 00  |........-.......|
00000340  b0 00 40 00 00 00 00 00  00 00 00 00 00 00 00 00  |..@.............|
00000350  34 00 00 00 10 00 02 00  e5 00 60 00 00 00 00 00  |4.........`.....|
00000360  00 00 00 00 00 00 00 00  40 00 00 00 10 00 02 00  |........@.......|
00000370  e5 00 60 00 00 00 00 00  00 00 00 00 00 00 00 00  |..`.............|
00000380  47 00 00 00 10 00 02 00  e8 00 60 00 00 00 00 00  |G.........`.....|
00000390  00 00 00 00 00 00 00 00  00 68 65 6c 6c 6f 5f 77  |.........hello_w|
000003a0  6f 72 6c 64 2e 61 73 6d  00 68 65 6c 6c 6f 5f 77  |orld.asm.hello_w|
000003b0  6f 72 6c 64 00 68 65 6c  6c 6f 5f 77 6f 72 6c 64  |orld.hello_world|
000003c0  5f 6c 65 6e 00 5f 73 74  61 72 74 00 5f 5f 62 73  |_len._start.__bs|
000003d0  73 5f 73 74 61 72 74 00  5f 65 64 61 74 61 00 5f  |s_start._edata._|
000003e0  65 6e 64 00                                       |end.|
000003e4
</code></pre></div></div>

<h2 id="global-file-structure">Global file structure</h2>

<p>An ELF file contains the following parts:</p>

<ul>
  <li>
    <p>ELF header. Points to the position of the section header table and the program header table.</p>
  </li>
  <li>
    <p>Section header table (optional on executable). Each has <code class="highlighter-rouge">e_shnum</code> section headers, each pointing to the position of a section.</p>
  </li>
  <li>
    <p>N sections, with <code class="highlighter-rouge">N &lt;= e_shnum</code> (optional on executable)</p>
  </li>
  <li>
    <p>Program header table (only on executable). Each has <code class="highlighter-rouge">e_phnum</code> program headers, each pointing to the position of a segment.</p>
  </li>
  <li>
    <p>N segments, with <code class="highlighter-rouge">N &lt;= e_phnum</code> (only on executable)</p>
  </li>
</ul>

<p>The order of those parts is <em>not</em> fixed: the only fixed thing is the ELF header that must be the first thing on the file: Generic docs say:</p>

<blockquote>
  <p>Although the figure shows the program header table immediately after the ELF header, and the section header table following the sections, actual files may differ. Moreover, sections and segments have no specified order. Only the ELF header has a fixed position in the file.</p>
</blockquote>

<p>In pictures: sample object file with three sections:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            +-------------------+
            | ELF header        |---+
+---------&gt; +-------------------+   | e_shoff
|           |                   |&lt;--+
| Section   | Section header 0  |
|           |                   |---+ sh_offset
| Header    +-------------------+   |
|           | Section header 1  |---|--+ sh_offset
| Table     +-------------------+   |  |
|           | Section header 2  |---|--|--+
+---------&gt; +-------------------+   |  |  |
            | Section 0         |&lt;--+  |  |
            +-------------------+      |  | sh_offset
            | Section 1         |&lt;-----+  |
            +-------------------+         |
            | Section 2         |&lt;--------+
            +-------------------+
</code></pre></div></div>

<p>But nothing (except sanity) prevents the following topology:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            +-------------------+
            | ELF header        |---+ e_shoff
            +-------------------+   |
            | Section 1         |&lt;--|--+
+---------&gt; +-------------------+   |  |
|           |                   |&lt;--+  | sh_offset
| Section   | Section header 0  |      |
|           |                   |------|---------+
| Header    +-------------------+      |         |
|           | Section header 1  |------+         |
| Table     +-------------------+                |
|           | Section header 2  |---+            | sh_offset
+---------&gt; +-------------------+   | sh_offset  |
            | Section 2         |&lt;--+            |
            +-------------------+                |
            | Section 0         |&lt;---------------+
            +-------------------+
</code></pre></div></div>

<p>But some newbies may prefer PNGs :-)</p>

<p><a href="/elf101.png"><img src="/elf101.png" alt="" /></a></p>

<p><a href="https://github.com/corkami/pics/blob/28cb0226093ed57b348723bc473cea0162dad366/binary/elf101/elf101.pdf">Image source</a>.</p>

<h2 id="section-vs-segment">Section vs segment</h2>

<p>We will get into more detail later, but it is good to have it in mind now:</p>

<ul>
  <li>
    <p>section: exists before linking, in object files.</p>

    <p>One ore more sections will be put inside a single segment by the linker.</p>

    <p>Major information sections contain for the linker:</p>

    <ul>
      <li>is this section
        <ul>
          <li>raw data to be loaded into memory, e.g. <code class="highlighter-rouge">.data</code>, <code class="highlighter-rouge">.text</code>, etc.</li>
          <li>or metadata about other sections, that will be used by the linker, but disappear at runtime e.g. <code class="highlighter-rouge">.symtab</code>, <code class="highlighter-rouge">.srttab</code>, <code class="highlighter-rouge">.rela.text</code></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>segment: exists after linking, in the executable file.</p>

    <p>Contains information about how each segment should be loaded into memory by the OS, notably location and permissions.</p>
  </li>
</ul>

<p>See also:</p>

<ul>
  <li><a href="https://stackoverflow.com/questions/14361248/whats-the-difference-of-section-and-segment-in-elf-file-format">https://stackoverflow.com/questions/14361248/whats-the-difference-of-section-and-segment-in-elf-file-format</a></li>
  <li><a href="https://stackoverflow.com/questions/23379880/difference-between-program-header-and-section-header-in-elf">https://stackoverflow.com/questions/23379880/difference-between-program-header-and-section-header-in-elf</a></li>
</ul>

<h2 id="elf-header">ELF header</h2>

<p><code class="highlighter-rouge">readelf -h hello_world.o</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
Class:                             ELF64
Data:                              2's complement, little endian
Version:                           1 (current)
OS/ABI:                            UNIX - System V
ABI Version:                       0
Type:                              REL (Relocatable file)
Machine:                           Advanced Micro Devices X86-64
Version:                           0x1
Entry point address:               0x0
Start of program headers:          0 (bytes into file)
Start of section headers:          64 (bytes into file)
Flags:                             0x0
Size of this header:               64 (bytes)
Size of program headers:           0 (bytes)
Number of program headers:         0
Size of section headers:           64 (bytes)
Number of section headers:         7
Section header string table index: 3
</code></pre></div></div>

<p><code class="highlighter-rouge">readelf -h hello_world.out</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
Class:                             ELF64
Data:                              2's complement, little endian
Version:                           1 (current)
OS/ABI:                            UNIX - System V
ABI Version:                       0
Type:                              EXEC (Executable file)
Machine:                           Advanced Micro Devices X86-64
Version:                           0x1
Entry point address:               0x4000b0
Start of program headers:          64 (bytes into file)
Start of section headers:          272 (bytes into file)
Flags:                             0x0
Size of this header:               64 (bytes)
Size of program headers:           56 (bytes)
Number of program headers:         2
Size of section headers:           64 (bytes)
Number of section headers:         6
Section header string table index: 3
</code></pre></div></div>

<p>Bytes in the object file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|
00000010  01 00 3e 00 01 00 00 00  00 00 00 00 00 00 00 00  |..&gt;.............|
00000020  00 00 00 00 00 00 00 00  40 00 00 00 00 00 00 00  |........@.......|
00000030  00 00 00 00 40 00 00 00  00 00 40 00 07 00 03 00  |....@.....@.....|
</code></pre></div></div>

<p>Executable:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|
00000010  02 00 3e 00 01 00 00 00  b0 00 40 00 00 00 00 00  |..&gt;.......@.....|
00000020  40 00 00 00 00 00 00 00  10 01 00 00 00 00 00 00  |@...............|
00000030  00 00 00 00 40 00 38 00  02 00 40 00 06 00 03 00  |....@.8...@.....|
</code></pre></div></div>

<p>Structure represented:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># define EI_NIDENT 16

typedef struct {
    unsigned char   e_ident[EI_NIDENT];
    Elf64_Half      e_type;
    Elf64_Half      e_machine;
    Elf64_Word      e_version;
    Elf64_Addr      e_entry;
    Elf64_Off       e_phoff;
    Elf64_Off       e_shoff;
    Elf64_Word      e_flags;
    Elf64_Half      e_ehsize;
    Elf64_Half      e_phentsize;
    Elf64_Half      e_phnum;
    Elf64_Half      e_shentsize;
    Elf64_Half      e_shnum;
    Elf64_Half      e_shstrndx;
} Elf64_Ehdr;
</code></pre></div></div>

<p>Manual breakdown:</p>

<ul>
  <li>
    <p>0 0: <code class="highlighter-rouge">EI_MAG</code> = <code class="highlighter-rouge">7f 45 4c 46</code> = <code class="highlighter-rouge">0x7f 'E', 'L', 'F'</code>: ELF magic number</p>
  </li>
  <li>
    <p>0 4: <code class="highlighter-rouge">EI_CLASS</code> = <code class="highlighter-rouge">02</code> = <code class="highlighter-rouge">ELFCLASS64</code>: 64 bit elf</p>
  </li>
  <li>
    <p>0 5: <code class="highlighter-rouge">EI_DATA</code> = <code class="highlighter-rouge">01</code> = <code class="highlighter-rouge">ELFDATA2LSB</code>: little endian data</p>
  </li>
  <li>
    <p>0 6: <code class="highlighter-rouge">EI_VERSION</code> = <code class="highlighter-rouge">01</code>: format version</p>
  </li>
  <li>
    <p>0 7: <code class="highlighter-rouge">EI_OSABI</code> (only in 2003 Update) = <code class="highlighter-rouge">00</code> = <code class="highlighter-rouge">ELFOSABI_NONE</code>: no extensions.</p>
  </li>
  <li>
    <p>0 8: <code class="highlighter-rouge">EI_PAD</code> = 8x <code class="highlighter-rouge">00</code>: reserved bytes. Must be set to 0.</p>
  </li>
  <li>
    <p>1 0: <code class="highlighter-rouge">e_type</code> = <code class="highlighter-rouge">01 00</code> = 1 (big endian) = <code class="highlighter-rouge">ET_REl</code>: relocatable format</p>

    <p>On the executable it is <code class="highlighter-rouge">02 00</code> for <code class="highlighter-rouge">ET_EXEC</code>.</p>

    <p>Another important possibility for the executable is <code class="highlighter-rouge">ET_DYN</code> for PIE executables and shared libraries.</p>

    <p><code class="highlighter-rouge">ET_DYN</code> tells the Linux kernel that the code is position independent, and can loaded at a random memory location with ASLR.</p>

    <p>This is explained further at:</p>

    <ul>
      <li>https://stackoverflow.com/questions/2463150/what-is-the-fpie-option-for-position-independent-executables-in-gcc-and-ld/51308031#51308031</li>
      <li>https://stackoverflow.com/questions/34519521/why-does-gcc-create-a-shared-object-instead-of-an-executable-binary-according-to/55704865#55704865</li>
    </ul>
  </li>
  <li>
    <p>1 2: <code class="highlighter-rouge">e_machine</code> = <code class="highlighter-rouge">3e 00</code> = <code class="highlighter-rouge">62</code> = <code class="highlighter-rouge">EM_X86_64</code>: AMD64 architecture</p>
  </li>
  <li>
    <p>1 4: <code class="highlighter-rouge">e_version</code> = <code class="highlighter-rouge">01 00 00 00</code>: must be 1</p>
  </li>
  <li>
    <p>1 8: <code class="highlighter-rouge">e_entry</code> = 8x <code class="highlighter-rouge">00</code>: execution address entry point, or 0 if not applicable like for the object file since there is no entry point.</p>

    <p>On the executable, it is <code class="highlighter-rouge">b0 00 40 00 00 00 00 00</code>. The kernel puts the RIP directly on that value when executing. It can be configured by the linker script or <code class="highlighter-rouge">-e</code>. But it will segfault if you set it too low: <a href="https://stackoverflow.com/questions/2187484/why-is-the-elf-execution-entry-point-virtual-address-of-the-form-0x80xxxxx-and-n">https://stackoverflow.com/questions/2187484/why-is-the-elf-execution-entry-point-virtual-address-of-the-form-0x80xxxxx-and-n</a></p>
  </li>
  <li>
    <p>2 0: <code class="highlighter-rouge">e_phoff</code> = 8x <code class="highlighter-rouge">00</code>: program header table offset, 0 if not present.</p>

    <p><code class="highlighter-rouge">40 00 00 00</code> on the executable, i.e. it starts immediately after the ELF header.</p>
  </li>
  <li>
    <p>2 8: <code class="highlighter-rouge">e_shoff</code> = <code class="highlighter-rouge">40</code> 7x <code class="highlighter-rouge">00</code> = <code class="highlighter-rouge">0x40</code>: section header table file offset, 0 if not present.</p>
  </li>
  <li>
    <p>3 0: <code class="highlighter-rouge">e_flags</code> =  <code class="highlighter-rouge">00 00 00 00</code> Arch specific. <code class="highlighter-rouge">i386</code> docs say:</p>

    <blockquote>
      <p>The Intel386 architecture defines no flags; so this member contains zero.</p>
    </blockquote>
  </li>
  <li>
    <p>3 4: <code class="highlighter-rouge">e_ehsize</code> =  <code class="highlighter-rouge">40 00 </code>: size of this elf header. TODO why this field needed? Isn’t the size fixed?</p>
  </li>
  <li>
    <p>3 6: <code class="highlighter-rouge">e_phentsize</code> =  <code class="highlighter-rouge">00 00 </code>: size of each program header, 0 if not present.</p>

    <p><code class="highlighter-rouge">38 00</code> on executable: it is 56 bytes long</p>
  </li>
  <li>
    <p>3 8: <code class="highlighter-rouge">e_phnum</code> =  <code class="highlighter-rouge">00 00 </code>: number of program header entries, 0 if not present.</p>

    <p><code class="highlighter-rouge">02 00</code> on executable: there are 2 entries.</p>
  </li>
  <li>
    <p>3 A: <code class="highlighter-rouge">e_shentsize</code> and <code class="highlighter-rouge">e_shnum</code> = <code class="highlighter-rouge">40 00 07 00</code>: section header size and number of entries</p>
  </li>
  <li>
    <p>3 E: <code class="highlighter-rouge">e_shstrndx</code> (<code class="highlighter-rouge">Section Header STRing iNDeX</code>) = <code class="highlighter-rouge">03 00</code>: index of the <code class="highlighter-rouge">.shstrtab</code> section.</p>
  </li>
</ul>

<h2 id="section-header-table">Section header table</h2>

<p>Array of <code class="highlighter-rouge">Elf64_Shdr</code> structs.</p>

<p>Each entry contains metadata about a given section.</p>

<p><code class="highlighter-rouge">e_shoff</code> of the ELF header gives the starting position, 0x40 here.</p>

<p><code class="highlighter-rouge">e_shentsize</code> and <code class="highlighter-rouge">e_shnum</code> from the ELF header say that we have 7 entries, each <code class="highlighter-rouge">0x40</code> bytes long.</p>

<p>So the table takes bytes from 0x40 to <code class="highlighter-rouge">0x40 + 7 + 0x40 - 1</code> = 0x1FF.</p>

<p>Some section names are reserved for certain section types: <a href="http://www.sco.com/developers/gabi/2003-12-17/ch4.sheader.html#special_sections">http://www.sco.com/developers/gabi/2003-12-17/ch4.sheader.html#special_sections</a> e.g. <code class="highlighter-rouge">.text</code> requires a <code class="highlighter-rouge">SHT_PROGBITS</code> type and <code class="highlighter-rouge">SHF_ALLOC</code> + <code class="highlighter-rouge">SHF_EXECINSTR</code></p>

<p><code class="highlighter-rouge">readelf -S hello_world.o</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>There are 7 section headers, starting at offset 0x40:

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .data             PROGBITS         0000000000000000  00000200
       000000000000000d  0000000000000000  WA       0     0     4
  [ 2] .text             PROGBITS         0000000000000000  00000210
       0000000000000027  0000000000000000  AX       0     0     16
  [ 3] .shstrtab         STRTAB           0000000000000000  00000240
       0000000000000032  0000000000000000           0     0     1
  [ 4] .symtab           SYMTAB           0000000000000000  00000280
       00000000000000a8  0000000000000018           5     6     4
  [ 5] .strtab           STRTAB           0000000000000000  00000330
       0000000000000034  0000000000000000           0     0     1
  [ 6] .rela.text        RELA             0000000000000000  00000370
       0000000000000018  0000000000000018           4     2     4
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), l (large)
  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)
</code></pre></div></div>

<p><code class="highlighter-rouge">struct</code> represented by each entry:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct {
    Elf64_Word  sh_name;
    Elf64_Word  sh_type;
    Elf64_Xword sh_flags;
    Elf64_Addr  sh_addr;
    Elf64_Off   sh_offset;
    Elf64_Xword sh_size;
    Elf64_Word  sh_link;
    Elf64_Word  sh_info;
    Elf64_Xword sh_addralign;
    Elf64_Xword sh_entsize;
} Elf64_Shdr;
</code></pre></div></div>

<h2 id="sections">Sections</h2>

<h3 id="index-0-section">Index 0 section</h3>

<p>Contained in bytes 0x40 to 0x7F.</p>

<p>The first section is always magic: <a href="http://www.sco.com/developers/gabi/2003-12-17/ch4.sheader.html">http://www.sco.com/developers/gabi/2003-12-17/ch4.sheader.html</a> says:</p>

<blockquote>
  <p>If the number of sections is greater than or equal to SHN_LORESERVE (0xff00), e_shnum has the value SHN_UNDEF (0) and the actual number of section header table entries is contained in the sh_size field of the section header at index 0 (otherwise, the sh_size member of the initial entry contains 0).</p>
</blockquote>

<p>There are also other magic sections detailed in <code class="highlighter-rouge">Figure 4-7: Special Section Indexes</code>.</p>

<h4 id="sht_null">SHT_NULL</h4>

<p>In index 0, <code class="highlighter-rouge">SHT_NULL</code> is mandatory. Are there any other uses for it: <a href="https://stackoverflow.com/questions/26812142/what-is-the-use-of-the-sht-null-section-in-elf">https://stackoverflow.com/questions/26812142/what-is-the-use-of-the-sht-null-section-in-elf</a> ?</p>

<h3 id="data-section">.data section</h3>

<p><code class="highlighter-rouge">.data</code> is section 1:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000080  01 00 00 00 01 00 00 00  03 00 00 00 00 00 00 00  |................|
00000090  00 00 00 00 00 00 00 00  00 02 00 00 00 00 00 00  |................|
000000a0  0d 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000b0  04 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
</code></pre></div></div>

<ul>
  <li>
    <p>80 0: <code class="highlighter-rouge">sh_name</code> = <code class="highlighter-rouge">01 00 00 00</code>: index 1 in the <code class="highlighter-rouge">.shstrtab</code> string table</p>

    <p>Here, <code class="highlighter-rouge">1</code> says the name of this section starts at the first character of that section, and ends at the first NUL character, making up the string <code class="highlighter-rouge">.data</code>.</p>

    <p><code class="highlighter-rouge">.data</code> is one of the section names which has a predefined meaning <a href="http://www.sco.com/developers/gabi/2003-12-17/ch4.strtab.html">http://www.sco.com/developers/gabi/2003-12-17/ch4.strtab.html</a></p>

    <blockquote>
      <p>These sections hold initialized data that contribute to the program’s memory image.</p>
    </blockquote>
  </li>
  <li>
    <p>80 4: <code class="highlighter-rouge">sh_type</code> = <code class="highlighter-rouge">01 00 00 00</code>: <code class="highlighter-rouge">SHT_PROGBITS</code>: the section content is not specified by ELF, only by how the program interprets it. Normal since a <code class="highlighter-rouge">.data</code> section.</p>
  </li>
  <li>
    <p>80 8: <code class="highlighter-rouge">sh_flags</code> = <code class="highlighter-rouge">03</code> 7x <code class="highlighter-rouge">00</code>: <code class="highlighter-rouge">SHF_WRITE</code> and <code class="highlighter-rouge">SHF_ALLOC</code>: <a href="http://www.sco.com/developers/gabi/2003-12-17/ch4.sheader.html#sh_flags">http://www.sco.com/developers/gabi/2003-12-17/ch4.sheader.html#sh_flags</a>, as required from a <code class="highlighter-rouge">.data</code> section</p>
  </li>
  <li>
    <p>90 0: <code class="highlighter-rouge">sh_addr</code> = 8x <code class="highlighter-rouge">00</code>: TODO: standard says:</p>

    <blockquote>
      <p>If the section will appear in the memory image of a process, this member gives the address at which the section’s first byte should reside. Otherwise, the member contains 0.</p>
    </blockquote>

    <p>but I don’t understand it very well yet.</p>
  </li>
  <li>
    <p>90 8: <code class="highlighter-rouge">sh_offset</code> = <code class="highlighter-rouge">00 02 00 00 00 00 00 00</code> = <code class="highlighter-rouge">0x200</code>: number of bytes from the start of the program to the first byte in this section</p>
  </li>
  <li>
    <p>a0 0: <code class="highlighter-rouge">sh_size</code> = <code class="highlighter-rouge">0d 00 00 00 00 00 00 00</code></p>

    <p>If we take 0xD bytes starting at  <code class="highlighter-rouge">sh_offset</code> 200, we see:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000200  48 65 6c 6c 6f 20 77 6f  72 6c 64 21 0a 00        |Hello world!..  |
</code></pre></div>    </div>

    <p>AHA! So our <code class="highlighter-rouge">"Hello world!"</code> string is in the data section like we told it to be on the NASM.</p>

    <p>Once we graduate from <code class="highlighter-rouge">hd</code>, we will look this up like:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readelf -x .data hello_world.o
</code></pre></div>    </div>

    <p>which outputs:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hex dump of section '.data':
  0x00000000 48656c6c 6f20776f 726c6421 0a       Hello world!.
</code></pre></div>    </div>

    <p>NASM sets decent properties for that section because it treats <code class="highlighter-rouge">.data</code> magically: <a href="https://www.nasm.us/doc/nasmdoc7.html#section-7.9.2">https://www.nasm.us/doc/nasmdoc7.html#section-7.9.2</a></p>

    <p>Also note that this was a bad section choice: a good C compiler would put the string in <code class="highlighter-rouge">.rodata</code> instead, because it is read-only and it would allow for further OS optimizations.</p>
  </li>
  <li>
    <p>a0 8: <code class="highlighter-rouge">sh_link</code> and <code class="highlighter-rouge">sh_info</code> = 8x 0: do not apply to this section type. <a href="http://www.sco.com/developers/gabi/2003-12-17/ch4.sheader.html#special_sections">http://www.sco.com/developers/gabi/2003-12-17/ch4.sheader.html#special_sections</a></p>
  </li>
  <li>
    <p>b0 0: <code class="highlighter-rouge">sh_addralign</code> = <code class="highlighter-rouge">04</code> = TODO: why is this alignment necessary? Is it only for <code class="highlighter-rouge">sh_addr</code>, or also for symbols inside <code class="highlighter-rouge">sh_addr</code>?</p>
  </li>
  <li>
    <p>b0 8: <code class="highlighter-rouge">sh_entsize</code> = <code class="highlighter-rouge">00</code> = the section does not contain a table. If != 0, it means that the section contains a table of fixed size entries. In this file, we see from the <code class="highlighter-rouge">readelf</code> output that this is the case for the <code class="highlighter-rouge">.symtab</code> and <code class="highlighter-rouge">.rela.text</code> sections.</p>
  </li>
</ul>

<h3 id="text-section">.text section</h3>

<p>Now that we’ve done one section manually, let’s graduate and use the <code class="highlighter-rouge">readelf -S</code> of the other sections.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 2] .text             PROGBITS         0000000000000000  00000210
       0000000000000027  0000000000000000  AX       0     0     16
</code></pre></div></div>

<p><code class="highlighter-rouge">.text</code> is executable but not writable: if we try to write to it Linux segfaults. Let’s see if we really have some code there:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>objdump -d hello_world.o
</code></pre></div></div>

<p>gives:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hello_world.o:     file format elf64-x86-64


Disassembly of section .text:

0000000000000000 &lt;_start&gt;:
   0:       b8 01 00 00 00          mov    $0x1,%eax
   5:       bf 01 00 00 00          mov    $0x1,%edi
   a:       48 be 00 00 00 00 00    movabs $0x0,%rsi
  11:       00 00 00
  14:       ba 0d 00 00 00          mov    $0xd,%edx
  19:       0f 05                   syscall
  1b:       b8 3c 00 00 00          mov    $0x3c,%eax
  20:       bf 00 00 00 00          mov    $0x0,%edi
  25:       0f 05                   syscall
</code></pre></div></div>

<p>If we grep <code class="highlighter-rouge">b8 01 00 00</code> on the <code class="highlighter-rouge">hd</code>, we see that this only occurs at <code class="highlighter-rouge">00000210</code>, which is what the section says. And the Size is 27, which matches as well. So we must be talking about the right section.</p>

<p>This looks like the right code: a <code class="highlighter-rouge">write</code> followed by an <code class="highlighter-rouge">exit</code>.</p>

<p>The most interesting part is line <code class="highlighter-rouge">a</code> which does:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>movabs $0x0,%rsi
</code></pre></div></div>

<p>to pass the address of the string to the system call. Currently, the <code class="highlighter-rouge">0x0</code> is just a placeholder. After linking happens, it will be modified to contain:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4000ba: 48 be d8 00 60 00 00    movabs $0x6000d8,%rsi
</code></pre></div></div>

<p>This modification is possible because of the data of the <code class="highlighter-rouge">.rela.text</code> section.</p>

<h3 id="sht_strtab">SHT_STRTAB</h3>

<p>Sections with <code class="highlighter-rouge">sh_type == SHT_STRTAB</code> are called <em>string tables</em>.</p>

<p>They hold a null separated array of strings.</p>

<p>Such sections are used by other sections when string names are to be used. The using section says:</p>

<ul>
  <li>which string table they are using</li>
  <li>what is the index on the target string table where the string starts</li>
</ul>

<p>So for example, we could have a string table containing:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Data: \0 a b c \0 d e f \0
Index: 0 1 2 3  4 5 6 7  8
</code></pre></div></div>

<p>The first byte must be a 0. TODO rationale?</p>

<p>And if another section wants to use the string <code class="highlighter-rouge">d e f</code>, they have to point to index <code class="highlighter-rouge">5</code> of this section (letter <code class="highlighter-rouge">d</code>).</p>

<p>Notable string table sections:</p>

<ul>
  <li><code class="highlighter-rouge">.shstrtab</code></li>
  <li><code class="highlighter-rouge">.strtab</code></li>
</ul>

<h3 id="shstrtab">.shstrtab</h3>

<p>Section type: <code class="highlighter-rouge">sh_type == SHT_STRTAB</code>.</p>

<p>Common name: <em>section header string table</em>.</p>

<p>The section name <code class="highlighter-rouge">.shstrtab</code> is reserved. The standard says:</p>

<blockquote>
  <p>This section holds section names.</p>
</blockquote>

<p>This section gets pointed to by the <code class="highlighter-rouge">e_shstrnd</code> field of the ELF header itself.</p>

<p>String indexes of this section are are pointed to by the <code class="highlighter-rouge">sh_name</code> field of section headers, which denote strings.</p>

<p>This section does not have <code class="highlighter-rouge">SHF_ALLOC</code> marked, so it will not appear on the executing program.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readelf -x .shstrtab hello_world.o
</code></pre></div></div>

<p>Gives:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hex dump of section '.shstrtab':
  0x00000000 002e6461 7461002e 74657874 002e7368 ..data..text..sh
  0x00000010 73747274 6162002e 73796d74 6162002e strtab..symtab..
  0x00000020 73747274 6162002e 72656c61 2e746578 strtab..rela.tex
  0x00000030 7400                                t.
</code></pre></div></div>

<p>The data in this section has a fixed format: <a href="http://www.sco.com/developers/gabi/2003-12-17/ch4.strtab.html">http://www.sco.com/developers/gabi/2003-12-17/ch4.strtab.html</a></p>

<p>If we look at the names of other sections, we see that they all contain numbers, e.g. the <code class="highlighter-rouge">.text</code> section is number <code class="highlighter-rouge">7</code>.</p>

<p>Then each string ends when the first NUL character is found, e.g. character <code class="highlighter-rouge">12</code> is <code class="highlighter-rouge">\0</code> just after <code class="highlighter-rouge">.text\0</code>.</p>

<h3 id="symtab">.symtab</h3>

<p>Section type: <code class="highlighter-rouge">sh_type == SHT_SYMTAB</code>.</p>

<p>Common name: <em>symbol table</em>.</p>

<p>First the we note that:</p>

<ul>
  <li><code class="highlighter-rouge">sh_link</code> = <code class="highlighter-rouge">5</code></li>
  <li><code class="highlighter-rouge">sh_info</code> = <code class="highlighter-rouge">6</code></li>
</ul>

<p>For <code class="highlighter-rouge">SHT_SYMTAB</code> sections, those numbers mean that:</p>

<ul>
  <li>strings that give symbol names are in section 5, <code class="highlighter-rouge">.strtab</code></li>
  <li>the relocation data is in section 6, <code class="highlighter-rouge">.rela.text</code></li>
</ul>

<p>A good high level tool to disassemble that section is:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nm hello_world.o
</code></pre></div></div>

<p>which gives:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000000000000000 T _start
0000000000000000 d hello_world
000000000000000d a hello_world_len
</code></pre></div></div>

<p>This is however a high level view that omits some types of symbols and in which the symbol types . A more detailed disassembly can be obtained with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readelf -s hello_world.o
</code></pre></div></div>

<p>which gives:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Symbol table '.symtab' contains 7 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS hello_world.asm
     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1
     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    2
     4: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT    1 hello_world
     5: 000000000000000d     0 NOTYPE  LOCAL  DEFAULT  ABS hello_world_len
     6: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT    2 _start
</code></pre></div></div>

<p>The binary format of the table is documented at <a href="http://www.sco.com/developers/gabi/2003-12-17/ch4.symtab.html">http://www.sco.com/developers/gabi/2003-12-17/ch4.symtab.html</a></p>

<p>The data is:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readelf -x .symtab hello_world.o
</code></pre></div></div>

<p>Which gives:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hex dump of section '.symtab':
  0x00000000 00000000 00000000 00000000 00000000 ................
  0x00000010 00000000 00000000 01000000 0400f1ff ................
  0x00000020 00000000 00000000 00000000 00000000 ................
  0x00000030 00000000 03000100 00000000 00000000 ................
  0x00000040 00000000 00000000 00000000 03000200 ................
  0x00000050 00000000 00000000 00000000 00000000 ................
  0x00000060 11000000 00000100 00000000 00000000 ................
  0x00000070 00000000 00000000 1d000000 0000f1ff ................
  0x00000080 0d000000 00000000 00000000 00000000 ................
  0x00000090 2d000000 10000200 00000000 00000000 -...............
  0x000000a0 00000000 00000000                   ........
</code></pre></div></div>

<p>The entries are of type:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct {
    Elf64_Word  st_name;
    unsigned char   st_info;
    unsigned char   st_other;
    Elf64_Half  st_shndx;
    Elf64_Addr  st_value;
    Elf64_Xword st_size;
} Elf64_Sym;
</code></pre></div></div>

<p>Like in the section table, the first entry is magical and set to a fixed meaningless values.</p>

<h4 id="stt_file">STT_FILE</h4>

<p>Entry 1 has <code class="highlighter-rouge">ELF64_R_TYPE == STT_FILE</code>. <code class="highlighter-rouge">ELF64_R_TYPE</code> is continued inside of <code class="highlighter-rouge">st_info</code>.</p>

<p>Byte analysis:</p>

<ul>
  <li>
    <p>10 8: <code class="highlighter-rouge">st_name</code> = <code class="highlighter-rouge">01000000</code> = character 1 in the <code class="highlighter-rouge">.strtab</code>, which until the following <code class="highlighter-rouge">\0</code> makes <code class="highlighter-rouge">hello_world.asm</code></p>

    <p>This piece of information file may be used by the linker to decide on which segment sections go: e.g. in <code class="highlighter-rouge">ld</code> linker script we write:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>segment_name :
{
    file(section)
}
</code></pre></div>    </div>

    <p>to pick a section from a given file.</p>

    <p>Most of the time however, we will just dump all sections with a given name together with:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>segment_name :
{
    *(section)
}
</code></pre></div>    </div>
  </li>
  <li>
    <p>10 12: <code class="highlighter-rouge">st_info</code> = <code class="highlighter-rouge">04</code></p>

    <p>Bits 0-3 = <code class="highlighter-rouge">ELF64_R_TYPE</code> = Type = <code class="highlighter-rouge">4</code> = <code class="highlighter-rouge">STT_FILE</code>: the main purpose of this entry is to use <code class="highlighter-rouge">st_name</code> to indicate the name of the file which generated this object file.</p>

    <p>Bits 4-7 =  <code class="highlighter-rouge">ELF64_ST_BIND</code> = Binding = <code class="highlighter-rouge">0</code> = <code class="highlighter-rouge">STB_LOCAL</code>. Required value for <code class="highlighter-rouge">STT_FILE</code>.</p>
  </li>
  <li>
    <p>10 13: <code class="highlighter-rouge">st_shndx</code> = Symbol Table Section header Index = <code class="highlighter-rouge">f1ff</code> = <code class="highlighter-rouge">SHN_ABS</code>. Required for <code class="highlighter-rouge">STT_FILE</code>.</p>
  </li>
  <li>
    <p>20 0: <code class="highlighter-rouge">st_value</code> = 8x <code class="highlighter-rouge">00</code>: required for value for <code class="highlighter-rouge">STT_FILE</code></p>
  </li>
  <li>
    <p>20 8: <code class="highlighter-rouge">st_size</code> = 8x <code class="highlighter-rouge">00</code>: no allocated size</p>
  </li>
</ul>

<p>Now from the <code class="highlighter-rouge">readelf</code>, we interpret the others quickly.</p>

<h4 id="stt_section">STT_SECTION</h4>

<p>There are two such entries, one pointing to <code class="highlighter-rouge">.data</code> and the other to <code class="highlighter-rouge">.text</code> (section indexes <code class="highlighter-rouge">1</code> and <code class="highlighter-rouge">2</code>).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Num:    Value          Size Type    Bind   Vis      Ndx Name
  2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1
  3: 0000000000000000     0 SECTION LOCAL  DEFAULT    2
</code></pre></div></div>

<p>TODO what is their purpose?</p>

<h4 id="stt_notype">STT_NOTYPE</h4>

<p>Then come the most important symbols:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Num:    Value          Size Type    Bind   Vis      Ndx Name
  4: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT    1 hello_world
  5: 000000000000000d     0 NOTYPE  LOCAL  DEFAULT  ABS hello_world_len
  6: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT    2 _start
</code></pre></div></div>

<p><code class="highlighter-rouge">hello_world</code> string is in the <code class="highlighter-rouge">.data</code> section (index 1). It’s value is 0: it points to the first byte of that section.</p>

<p><code class="highlighter-rouge">_start</code> is marked with <code class="highlighter-rouge">GLOBAL</code> visibility since we wrote:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global _start
</code></pre></div></div>

<p>in NASM. This is necessary since it must be seen as the entry point. Unlike in C, by default NASM labels are local.</p>

<h5 id="shn_abs">SHN_ABS</h5>

<p><code class="highlighter-rouge">hello_world_len</code> points to the special <code class="highlighter-rouge">st_shndx == SHN_ABS == 0xF1FF</code>.</p>

<p><code class="highlighter-rouge">0xF1FF</code> is chosen so as to not conflict with other sections.</p>

<p><code class="highlighter-rouge">st_value == 0xD == 13</code> which is the value we have stored there on the assembly: the length of the string <code class="highlighter-rouge">Hello World!</code>.</p>

<p>This means that relocation will not affect this value: it is a constant.</p>

<p>This is small optimization that our assembler does for us and which has ELF support.</p>

<p>If we had used the address of <code class="highlighter-rouge">hello_world_len</code> anywhere, the assembler would not have been able to mark it as <code class="highlighter-rouge">SHN_ABS</code>, and the linker would have extra relocation work on it later.</p>

<h4 id="sht_symtab-on-the-executable">SHT_SYMTAB on the executable</h4>

<p>By default, NASM places a <code class="highlighter-rouge">.symtab</code> on the executable as well.</p>

<p>This is only used for debugging. Without the symbols, we are completely blind, and must reverse engineer everything.</p>

<p>You can strip it with <code class="highlighter-rouge">objcopy</code>, and the executable will still run. Such executables are called <em>stripped executables</em>.</p>

<h3 id="strtab">.strtab</h3>

<p>Holds strings for the symbol table.</p>

<p>This section has <code class="highlighter-rouge">sh_type == SHT_STRTAB</code>.</p>

<p>It is pointed to by <code class="highlighter-rouge">sh_link == 5</code> of the <code class="highlighter-rouge">.symtab</code> section.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readelf -x .strtab hello_world.o
</code></pre></div></div>

<p>Gives:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hex dump of section '.strtab':
  0x00000000 0068656c 6c6f5f77 6f726c64 2e61736d .hello_world.asm
  0x00000010 0068656c 6c6f5f77 6f726c64 0068656c .hello_world.hel
  0x00000020 6c6f5f77 6f726c64 5f6c656e 005f7374 lo_world_len._st
  0x00000030 61727400                            art.
</code></pre></div></div>

<p>This implies that it is an ELF level limitation that global variables cannot contain NUL characters.</p>

<h3 id="relatext">.rela.text</h3>

<p>Section type: <code class="highlighter-rouge">sh_type == SHT_RELA</code>.</p>

<p>Common name: <em>relocation section</em>.</p>

<p><code class="highlighter-rouge">.rela.text</code> holds relocation data which says how the address should be modified when the final executable is linked. This points to bytes of the text area that must be modified when linking happens to point to the correct memory locations.</p>

<p>Basically, it translates the object text containing the placeholder 0x0 address:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   a:       48 be 00 00 00 00 00    movabs $0x0,%rsi
  11:       00 00 00
</code></pre></div></div>

<p>to the actual executable code containing the final 0x6000d8:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4000ba: 48 be d8 00 60 00 00    movabs $0x6000d8,%rsi
4000c1: 00 00 00
</code></pre></div></div>

<p>It was pointed to by <code class="highlighter-rouge">sh_info</code> = <code class="highlighter-rouge">6</code> of the <code class="highlighter-rouge">.symtab</code> section.</p>

<p><code class="highlighter-rouge">readelf -r hello_world.o</code> gives:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Relocation section '.rela.text' at offset 0x3b0 contains 1 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
00000000000c  000200000001 R_X86_64_64       0000000000000000 .data + 0
</code></pre></div></div>

<p>The section does not exist in the executable.</p>

<p>The actual bytes are:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000370  0c 00 00 00 00 00 00 00  01 00 00 00 02 00 00 00  |................|
00000380  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
</code></pre></div></div>

<p>The <code class="highlighter-rouge">struct</code> represented is:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct {
    Elf64_Addr  r_offset;
    Elf64_Xword r_info;
    Elf64_Sxword    r_addend;
} Elf64_Rela;
</code></pre></div></div>

<p>So:</p>

<ul>
  <li>
    <p>370 0: <code class="highlighter-rouge">r_offset</code> = 0xC: address into the <code class="highlighter-rouge">.text</code> whose address this relocation will modify</p>
  </li>
  <li>
    <p>370 8: <code class="highlighter-rouge">r_info</code> = 0x200000001. Contains 2 fields:</p>

    <ul>
      <li><code class="highlighter-rouge">ELF64_R_TYPE</code> = 0x1: meaning depends on the exact architecture.</li>
      <li><code class="highlighter-rouge">ELF64_R_SYM</code> = 0x2: index of the section to which the address points, so <code class="highlighter-rouge">.data</code> which is at index 2.</li>
    </ul>

    <p>The AMD64 ABI says that type <code class="highlighter-rouge">1</code> is called <code class="highlighter-rouge">R_X86_64_64</code> and that it represents the operation <code class="highlighter-rouge">S + A</code> where:</p>

    <ul>
      <li><code class="highlighter-rouge">S</code>: the value of the symbol on the object file, here <code class="highlighter-rouge">0</code> because we point to the <code class="highlighter-rouge">00 00 00 00 00 00 00 00</code> of <code class="highlighter-rouge">movabs $0x0,%rsi</code></li>
      <li><code class="highlighter-rouge">A</code>: the addend, present in field <code class="highlighter-rouge">r_added</code></li>
    </ul>

    <p>This address is added to the section on which the relocation operates.</p>

    <p>This relocation operation acts on a total 8 bytes.</p>
  </li>
  <li>
    <p>380 0: <code class="highlighter-rouge">r_addend</code> = 0</p>
  </li>
</ul>

<p>So in our example we conclude that the new address will be: <code class="highlighter-rouge">S + A</code> = <code class="highlighter-rouge">.data + 0</code>, and thus the first thing in the data section.</p>

<h4 id="reltext">.rel.text</h4>

<p>Besides <code class="highlighter-rouge">sh_type == SHT_RELA</code>, there also exists <code class="highlighter-rouge">SHT_REL</code>, which would have section name <code class="highlighter-rouge">.text.rel</code> (not present in this object file).</p>

<p>Those represent the same <code class="highlighter-rouge">struct</code>, but without the addend, e.g.:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct {
    Elf64_Addr  r_offset;
    Elf64_Xword r_info;
} Elf64_Rela;
</code></pre></div></div>

<p>The ELF standard says that in many cases the both can be used, and it is just a matter of convenience.</p>

<h3 id="dynamic-linking-sections">Dynamic linking sections</h3>

<p>This program did not have certain dynamic linking related sections because we linked it minimally with <code class="highlighter-rouge">ld</code>.</p>

<p>However, if you compile a C hello world with GCC 8.2:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -o main.out main.c
</code></pre></div></div>

<p>some other interesting sections would appear.</p>

<h4 id="pt_interp">PT_INTERP</h4>

<p>Contains the path to the dynamic loader, i.e. <code class="highlighter-rouge">/lib64/ld-linux-x86-64.so.2</code> in Ubuntu 18.10. Explained at: https://stackoverflow.com/questions/8040631/checking-if-a-binary-compiled-with-static/55664341#55664341</p>

<h4 id="dynamic-section">Dynamic section</h4>

<p>Contains a lot of different flag masks.</p>

<h5 id="dt_flags_1">DT_FLAGS_1</h5>

<p>Seems to be a GNU Binutils extension</p>

<h6 id="df_1_pie">DF_1_PIE</h6>

<p>Determines if an executable is a position independent executable (PIE).</p>

<p>Seems to be informational only, since not used by Linux kernel 5.0 or glibc 2.29.</p>

<p><code class="highlighter-rouge">file</code> 5.36 however does use it to display file type as explained at: https://stackoverflow.com/questions/34519521/why-does-gcc-create-a-shared-object-instead-of-an-executable-binary-according-to/55704865#55704865</p>

<h2 id="program-header-table">Program header table</h2>

<p>Only appears in the executable.</p>

<p>Contains information of how the executable should be put into the process virtual memory.</p>

<p>The executable is generated from object files by the linker. The main jobs that the linker does are:</p>

<ul>
  <li>
    <p>determine which sections of the object files will go into which segments of the executable.</p>

    <p>In Binutils, this comes down to parsing a linker script, and dealing with a bunch of defaults.</p>

    <p>You can get the linker script used with <code class="highlighter-rouge">ld --verbose</code>, and set a custom one with <code class="highlighter-rouge">ld -T</code>.</p>
  </li>
  <li>
    <p>do relocation according to the <code class="highlighter-rouge">.rela.text</code> section. This depends on how the multiple sections are put into memory.</p>
  </li>
</ul>

<p><code class="highlighter-rouge">readelf -l hello_world.out</code> gives:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Elf file type is EXEC (Executable file)
Entry point 0x4000b0
There are 2 program headers, starting at offset 64

Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000
                 0x00000000000000d7 0x00000000000000d7  R E    200000
  LOAD           0x00000000000000d8 0x00000000006000d8 0x00000000006000d8
                 0x000000000000000d 0x000000000000000d  RW     200000

 Section to Segment mapping:
  Segment Sections...
   00     .text
   01     .data
</code></pre></div></div>

<p>On the ELF header, <code class="highlighter-rouge">e_phoff</code>, <code class="highlighter-rouge">e_phnum</code> and <code class="highlighter-rouge">e_phentsize</code> told us that there are 2 program headers, which start at <code class="highlighter-rouge">0x40</code> and are <code class="highlighter-rouge">0x38</code> bytes long each, so they are:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000040  01 00 00 00 05 00 00 00  00 00 00 00 00 00 00 00  |................|
00000050  00 00 40 00 00 00 00 00  00 00 40 00 00 00 00 00  |..@.......@.....|
00000060  d7 00 00 00 00 00 00 00  d7 00 00 00 00 00 00 00  |................|
00000070  00 00 20 00 00 00 00 00                           |.. .....        |
</code></pre></div></div>

<p>and:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000070                           01 00 00 00 06 00 00 00  |        ........|
00000080  d8 00 00 00 00 00 00 00  d8 00 60 00 00 00 00 00  |..........`.....|
00000090  d8 00 60 00 00 00 00 00  0d 00 00 00 00 00 00 00  |..`.............|
000000a0  0d 00 00 00 00 00 00 00  00 00 20 00 00 00 00 00  |.......... .....|
</code></pre></div></div>

<p>Structure represented <a href="http://www.sco.com/developers/gabi/2003-12-17/ch5.pheader.html">http://www.sco.com/developers/gabi/2003-12-17/ch5.pheader.html</a>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct {
    Elf64_Word  p_type;
    Elf64_Word  p_flags;
    Elf64_Off   p_offset;
    Elf64_Addr  p_vaddr;
    Elf64_Addr  p_paddr;
    Elf64_Xword p_filesz;
    Elf64_Xword p_memsz;
    Elf64_Xword p_align;
} Elf64_Phdr;
</code></pre></div></div>

<p>Breakdown of the first one:</p>

<ul>
  <li>
    <p>40 0: <code class="highlighter-rouge">p_type</code> = <code class="highlighter-rouge">01 00 00 00</code> = <code class="highlighter-rouge">PT_LOAD</code>: this is a regular segment that will get loaded in memory.</p>
  </li>
  <li>
    <p>40 4: <code class="highlighter-rouge">p_flags</code> = <code class="highlighter-rouge">05 00 00 00</code> = execute and read permissions. No write: we cannot modify the text segment. A classic way to do this in C is with string literals: <a href="https://stackoverflow.com/a/30662565/895245">https://stackoverflow.com/a/30662565/895245</a> This allows kernels to do certain optimizations, like sharing the segment amongst processes.</p>
  </li>
  <li>
    <p>40 8: <code class="highlighter-rouge">p_offset</code> = 8x <code class="highlighter-rouge">00</code> TODO: what is this? Standard says:</p>

    <blockquote>
      <p>This member gives the offset from the beginning of the file at which the first byte of the segment resides.</p>
    </blockquote>

    <p>But it looks like offsets from the beginning of <em>segments</em>, not file?</p>
  </li>
  <li>
    <p>50 0: <code class="highlighter-rouge">p_vaddr</code> = <code class="highlighter-rouge">00 00 40 00 00 00 00 00</code>: initial virtual memory address to load this segment to</p>
  </li>
  <li>
    <p>50 8: <code class="highlighter-rouge">p_paddr</code> = <code class="highlighter-rouge">00 00 40 00 00 00 00 00</code>: unspecified effect. Intended for systems in which physical addressing matters. TODO example?</p>
  </li>
  <li>
    <p>60 0: <code class="highlighter-rouge">p_filesz</code> = <code class="highlighter-rouge">d7 00 00 00 00 00 00 00</code>: size that the segment occupies in memory. If smaller than <code class="highlighter-rouge">p_memsz</code>, the OS fills it with zeroes to fit when loading the program. This is how BSS data is implemented to save space on executable files. i368 ABI says on <code class="highlighter-rouge">PT_LOAD</code>:</p>

    <blockquote>
      <p>The bytes from the file are mapped to the beginning of the memory segment. If the segment’s memory size (p_memsz) is larger than the file size (p_filesz), the ‘‘extra’’ bytes are defined to hold the value 0 and to follow the segment’s initialized area. The file size may not be larger than the memory size.</p>
    </blockquote>
  </li>
  <li>
    <p>60 8: <code class="highlighter-rouge">p_memsz</code> = <code class="highlighter-rouge">d7 00 00 00 00 00 00 00</code>: size that the segment occupies in memory</p>
  </li>
  <li>
    <p>70 0: <code class="highlighter-rouge">p_align</code> =  <code class="highlighter-rouge">00 00 20 00 00 00 00 00</code>: 0 or 1 mean no alignment required. TODO why is this required? Why not just use <code class="highlighter-rouge">p_addr</code> directly, and get that right? Docs also say:</p>

    <blockquote>
      <p>p_vaddr should equal p_offset, modulo p_align</p>
    </blockquote>
  </li>
</ul>

<p>The second segment (<code class="highlighter-rouge">.data</code>) is analogous. TODO: why use offset <code class="highlighter-rouge">0x0000d8</code> and address <code class="highlighter-rouge">0x00000000006000d8</code>? Why not just use <code class="highlighter-rouge">0</code> and <code class="highlighter-rouge">0x00000000006000d8</code>?</p>

<p>Then the:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Section to Segment mapping:
</code></pre></div></div>

<p>section of the <code class="highlighter-rouge">readelf</code> tells us that:</p>

<ul>
  <li>0 is the <code class="highlighter-rouge">.text</code> segment. Aha, so this is why it is executable, and not writable</li>
  <li>1 is the <code class="highlighter-rouge">.data</code> segment.</li>
</ul>

<p>TODO where does this information come from? <a href="https://stackoverflow.com/questions/23018496/section-to-segment-mapping-in-elf-files">https://stackoverflow.com/questions/23018496/section-to-segment-mapping-in-elf-files</a></p>

<h2 id="backlinks">Backlinks</h2>

<ul>
  <li>2017-05: <a href="https://news.ycombinator.com/item?id=14359159">https://news.ycombinator.com/item?id=14359159</a> <a href="https://web.archive.org/web/20170517174951/https://news.ycombinator.com/news">https://web.archive.org/web/20170517174951/https://news.ycombinator.com/news</a></li>
</ul>

        </main>
      </div>
      <footer>
        <p>Content licence: <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> unless otherwise noted on the article.</p>
        <p>Website powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a> and <a href="https://pages.github.com/">GitHub Pages</a>. Source at: <a href="https://github.com/cirosantilli/cirosantilli.github.io">https://github.com/cirosantilli/cirosantilli.github.io</a></p>
        <p>To contact me publicly about any general subject, including saying hi or suggestions about this website, please <a href="https://github.com/cirosantilli/cirosantilli.github.io/issues/new">create a GitHub issue in the cirosantilli.github.io repo</a>.</p>
        <p>
          For comments about China, please first read
          <a href="https://github.com/cirosantilli/china-dictatorship#faq">the FAQ</a> and
          <a href="https://github.com/cirosantilli/china-dictatorship/blob/master/CONTRIBUTING.md">the CONTRIBUTING</a> and then
          <a href="https://github.com/cirosantilli/china-dictatorship/issues/new">create a GitHub issue in the china-dictatorship repo</a>.
        </p>
        <p>If you absolutely need private contact, extract my email from my GitHub repos or use LinkedIn.</p>
        <p>
          <a href="https://en.wikipedia.org/wiki/Disqus">Disqus comments</a> were removed from this website in 2019-05-04,
          a manual dump is <a href="/disqus-archive/">available here</a>.
          <a href="https://github.com/cirosantilli/cirosantilli.github.io/tree/fee98be02a34d5d4ccf829c4df89f1a5140881fc#why-i-removed-disqus-comments-from-the-website-in-2019-05-04">Rationale</a>.
        </p>
        <p>Opinions and content are my own, not my employer's.</p>
      </footer>
        
    </div>
    <!-- Scripts -->
      <!--data table-->
        <script src="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js" ></script>
        <script>
          $('.data-table').dataTable({
            //"aaSorting": [[0,'asc'], [1,'asc'], [2, 'asc'], [3, 'asc']],
            "aaSorting": [],
            "bFilter": false,
            "bInfo": false,
            "bPaginate": false
          });
        </script>
      <!--mathjax-->
        <script
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
        ></script>
        <script>
          MathJax.Hub.Config({
              jax: ["input/TeX","output/HTML-CSS"],
              displayAlign: "left",
              displayIndent: "20px"
          });
        </script>
      <!--google analytics-->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47867706-1', 'auto');
          ga('require', 'displayfeatures');
          ga('send', 'pageview');

        </script>
  </body>
</html>
